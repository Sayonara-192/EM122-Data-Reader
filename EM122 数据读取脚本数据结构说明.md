### 1. 概览

本脚本将 Kongsberg EM122 `.all` 原始二进制文件解析并转换为内存高效的 Python 字典结构。数据存储采用了 **“扁平化数组 + 索引映射” (Flattened Arrays + Index Mapping)** 策略。

这种设计在保持 NumPy 矢量化计算高性能的同时，通过辅助索引数组保留了原始数据的 Ping（声波发射周期）时序结构。

**返回数据类型**：`dict` (Python 字典)

### 2. 核心数据层级

返回的字典包含两类核心数据：

#### 2.1 地理空间点云数据 (Geospatial Point Cloud Data)


这一层存储了所有波束的物理测量值。所有数据均被展平为**一维 NumPy 数组**，去除了 Ping 的边界。所有数组长度相等（等于文件总有效波束数 $N_{total}$），且严格对齐。

|**字典键 (Key)**|**数据类型 (Dtype)**|**物理含义**|**单位**|**详细说明**|
|---|---|---|---|---|
|**`"lat"`**|`float64`|**纬度 (Latitude)**|度 (°)|WGS84 椭球下的绝对纬度。由船只位置、航向结合波束偏移量经 Vincenty 大地测量公式计算得出。|
|**`"lon"`**|`float64`|**经度 (Longitude)**|度 (°)|WGS84 椭球下的绝对经度。|
|**`"z"`**|`float64`|**深度 (Depth)**|米 (m)|垂直方向距离（向下为正）。来自 XYZ88 数据报。|
|**`"bs"`**|`float64`|**强度 (Backscatter)**|分贝 (dB)|海底反向散射强度/反射率。|
|**`"ang"`**|`float64`|**波束角 (Beam Angle)**|度 (°)|波束指向角。以换能器正下方为 0 度，右舷为正，左舷为负。计算公式：$\theta = \arctan(\frac{AcrossTrack}{Depth})$。|

#### 2.2 索引元数据 (Index Metadata)


这一层存储了 Ping 的结构信息，用于将上述扁平化的点云数据还原为以 Ping 为单位的结构。数组长度等于总 Ping 数 $M_{pings}$。

| **字典键 (Key)**       | **数据类型 (Dtype)** | **含义**     | **说明**                                                                                             |
| ------------------- | ---------------- | ---------- | -------------------------------------------------------------------------------------------------- |
| **`"ping_counts"`** | `int32`          | **波束计数**   | 记录每个 Ping 包含的有效波束数量。<br>例如：`[432, 430, 432, ...]`                                                  |
| **`"ping_starts"`** | `int32`          | **起始索引指针** | 记录每个 Ping 在点云大数组中的**起始下标**。<br>它是 `ping_counts` 的累积求和，用于快速切片 (Slicing)。<br>例如：`[0, 432, 862, ...]` |
| **`"ping_times"`**  | `float64`        | **时间戳**    | 记录每个 Ping 发射瞬间的精确时间 (Unix Timestamp)。<br>这是进行坐标插值计算的时间基准。                                          |

---

### 3. 内存逻辑结构图解

假设文件处理了 3 个 Ping，波束数分别为 2, 3, 2：

**内存中的存储形态 (以深度 "z" 为例)：**

Plaintext

```
内存索引(Index):      0      1      2      3      4      5      6
---------------------------------------------------------------------
深度数组 "z":      [ 50.1, 50.2,  51.5, 51.6, 51.8,  50.3, 50.4 ]
                    \__________/  \_________________/  \__________/
逻辑归属:              Ping #0          Ping #1           Ping #2
```

**辅助索引数组：**

- `"ping_counts"`: `[2, 3, 2]` (每个 Ping 的长度)
    
- `"ping_starts"`: `[0, 2, 5]` (每个 Ping 的起点)
    

---

### 4. 数据访问指南

根据应用场景，建议采用以下两种访问模式：

#### 模式 A：全图矩阵计算 (推荐)

适用于生成网格 (Grid)、统计直方图、整体坐标转换或导出点云文件。直接操作一维数组，利用 NumPy 的 SIMD 优势。

Python

```
# 示例：计算全区平均水深
mean_depth = np.mean(data["z"])

# 示例：导出 XYZ 文本文件
points = np.column_stack((data["lon"], data["lat"], data["z"]))
```

#### 模式 B：逐 Ping 访问 (时间序列处理)

适用于去除坏 Ping、按时间段筛选数据或分析单 Ping 剖面。利用索引数组进行“零拷贝”切片。

Python

```
# 示例：访问第 i 个 Ping 的所有数据
i = 100
idx_start = data["ping_starts"][i]
idx_end   = idx_start + data["ping_counts"][i]

# 获取切片 (View)，极快且不消耗额外内存
ping_lat = data["lat"][idx_start : idx_end]
ping_z   = data["z"][idx_start : idx_end]
ping_time = data["ping_times"][i]
```